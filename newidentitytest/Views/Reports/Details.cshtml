@model newidentitytest.Models.ReportDetailsViewModel
@{
    ViewData["Title"] = "Report Details";
}

<section class="mx-auto max-w-3xl">
  <div class="bg-white rounded-2xl shadow-sm ring-1 ring-gray-200 p-6 space-y-4">
    <header>
      @* Page title and a short summary line with sender and date *@
      <h1 class="text-2xl font-semibold">Report @Model.Report.Id</h1>
      <p class="text-gray-600">Submitted by @Model.Sender on @Model.Report.CreatedAt.ToString("g")</p>
    </header>

        @* Status Badge *@
        <div class="flex items-center gap-2">
            @if (Model.Report.Status == "Approved")
            {
                <span class="inline-flex items-center rounded-full bg-green-100 px-3 py-1 text-sm font-medium text-green-500">
                     Approved
                </span>
            }
            else if (Model.Report.Status == "Rejected")
            {
                <span class="inline-flex items-center rounded-full bg-red-100 px-3 py-1 text-sm font-medium text-red-500">
                     Rejected
                </span>
            }
            else
            {
                <span class="inline-flex items-center rounded-full bg-yellow-100 px-3 py-1 text-sm font-medium text-yellow-800">
                     Pending Review
                </span>
            }
        </div>

    @* Definition list presents key/value pairs neatly *@
    <dl class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div>
        <dt class="text-sm text-gray-600">Obstacle Type</dt>
        <dd class="mt-1">@(Model.Report.ObstacleType ?? "-")</dd>
      </div>
      <div>
        <dt class="text-sm text-gray-600">Height</dt>
        <dd class="mt-1">
          @{
              string heightDisplay = "-";
              if (Model.Report.ObstacleHeight.HasValue)
              {
                  // Store height in meters and convert to feet (1 m = 3.28084 ft)
                  decimal meters = (decimal)Model.Report.ObstacleHeight.Value;
                  decimal feet = meters * 3.28084m;
                  heightDisplay = $"{meters:0.#} m ({feet:0.#} ft)";
              }
          }
          @heightDisplay
        </dd>
      </div>
      <div>
        <dt class="text-sm text-gray-600">Reported At</dt>
        <dd class="mt-1">@Model.Report.CreatedAt.ToString("g")</dd>
      </div>
      <div class="sm:col-span-2">
        <dt class="text-sm text-gray-600">Description</dt>
        <dd class="mt-1">@Model.Report.ObstacleDescription</dd>
      </div>

            @if (Model.Report.ProcessedAt.HasValue)
            {
                <div>
                    <dt class="text-sm text-gray-600">Processed</dt>
                    <dd class="mt-1">@Model.Report.ProcessedAt.Value.ToString("MMM dd, yyyy HH:mm")</dd>
                </div>
            }
            @if (!string.IsNullOrEmpty(Model.Report.RejectionReason))
            {
                <div class="sm:col-span-2">
                    <dt class="text-sm text-gray-600">Rejection Reason</dt>
                    <dd class="mt-1 bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        @Model.Report.RejectionReason
                    </dd>
                </div>
            }
    </dl>

    @if (!string.IsNullOrWhiteSpace(Model.Report.ObstacleLocation))
    {
      <div class="mt-4 space-y-2">
        <p>
          <strong>Location:</strong>
          @{
              try
              {
                  var geo = System.Text.Json.JsonSerializer.Deserialize<System.Text.Json.JsonElement>(Model.Report.ObstacleLocation);
                  if (geo.TryGetProperty("coordinates", out var coords) && coords.ValueKind == System.Text.Json.JsonValueKind.Array)
                  {
                      // Point: [lng, lat]
                      if (coords.GetArrayLength() >= 2 &&
                          coords[0].ValueKind == System.Text.Json.JsonValueKind.Number &&
                          coords[1].ValueKind == System.Text.Json.JsonValueKind.Number)
                      {
                          var lng = coords[0].GetDouble();
                          var lat = coords[1].GetDouble();
                          <text>Lat: @lat, Lng: @lng</text>
                      }
                      // LineString: [[lng,lat], [lng,lat], ...]
                      else if (coords.GetArrayLength() > 0 && coords[0].ValueKind == System.Text.Json.JsonValueKind.Array)
                      {
                          var parts = new List<string>();
                          foreach (var c in coords.EnumerateArray())
                          {
                              if (c.ValueKind == System.Text.Json.JsonValueKind.Array && c.GetArrayLength() >= 2)
                              {
                                  var lng = c[0].GetDouble();
                                  var lat = c[1].GetDouble();
                                  parts.Add($"(Lat: {lat}, Lng: {lng})");
                              }
                          }
                          <text>Coords: @string.Join(" → ", parts)</text>
                      }
                      else
                      {
                          <text>-</text>
                      }
                  }
                  else
                  {
                      <text>-</text>
                  }
              }
              catch
              {
                  <text>-</text>
              }
          }
        </p>
        <div id="map" style="height: 360px;" class="rounded-xl ring-1 ring-gray-200"></div>
      </div>
      <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
      <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
      <script>
        // Try to parse the stored GeoJSON-like string and render a Leaflet map
        try {
          // ObstacleLocation is already a JSON string, so we need to handle it correctly
          var locationStr = @Json.Serialize(Model.Report.ObstacleLocation);
          var geo = JSON.parse(locationStr);
          
          // Handle both Point and LineString types
          if (geo && geo.type === 'Point' && Array.isArray(geo.coordinates)) {
            var lng = geo.coordinates[0];
            var lat = geo.coordinates[1];
            var map = L.map('map').setView([lat, lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
            L.marker([lat, lng]).addTo(map);
          } else if (geo && geo.type === 'LineString' && Array.isArray(geo.coordinates)) {
            var latlngs = geo.coordinates.map(function(c){ return [c[1], c[0]]; });
            var map = L.map('map');
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
            var pl = L.polyline(latlngs, { color: 'red', weight: 4, opacity: 1 }).addTo(map);
            map.fitBounds(pl.getBounds(), { padding: [20, 20] });
          }
        } catch(e) { 
          console.warn('Could not parse location JSON', e); 
        }
      </script>
    }

        @* Action buttons for Registrar *@
        @if (User.IsInRole("Registrar") || User.IsInRole("Admin"))
        {
            @if (Model.Report.Status == "Pending")
            {
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 space-y-3">
                    <h3 class="font-semibold text-blue-900">Process Report</h3>
                    <div class="flex gap-3">
                        <form asp-action="Approve" method="post" class="flex-1">
                            <input type="hidden" name="id" value="@Model.Report.Id" />
                            <button type="submit"
                                    onclick="return confirm('Are you sure you want to approve this report?');"
                                    class="w-full inline-flex justify-center items-center rounded-lg px-4 py-2 bg-green-600 text-white hover:bg-green-700">
                                 Approve Report
                            </button>
                        </form>
                        <button type="button"
                                onclick="document.getElementById('rejectModal').classList.remove('hidden')"
                                class="flex-1 inline-flex justify-center items-center rounded-lg px-4 py-2 bg-red-600 text-white hover:bg-red-700">
                             Reject Report
                        </button>
                    </div>
                </div>
            }
            else
            {
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                    <p class="text-sm text-gray-600">This report has already been processed (@Model.Report.Status).</p>
                </div>
            }
        }

        <div class="pt-2">
            <a asp-controller="Reports" asp-action="Index" class="inline-flex items-center rounded-lg px-4 py-2 ring-1 ring-gray-300 hover:bg-gray-50">Back to Reports</a>
        </div>
    </div>

    @* Rejection Modal *@
    <div id="rejectModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999]">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4">
            <form asp-action="Reject" method="post">
                <div class="bg-red-600 text-white px-6 py-4 rounded-t-xl">
                    <h3 class="text-lg font-semibold">Reject Report</h3>
                </div>
                <div class="p-6">
                    <input type="hidden" name="id" value="@Model.Report.Id" />
                    <label for="rejectionReason" class="block text-sm font-medium text-gray-700 mb-2">
                        Rejection Reason *
                    </label>
                    <textarea id="rejectionReason"
                              name="rejectionReason"
                              rows="4"
                              required
                              class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500"
                              placeholder="Write the reason for rejection..."></textarea>
                    <p class="mt-2 text-sm text-gray-500">This message will be shown to the reporter.</p>
                </div>
                <div class="px-6 py-4 bg-gray-50 rounded-b-xl flex gap-3 justify-end">
                    <button type="button"
                            onclick="document.getElementById('rejectModal').classList.add('hidden')"
                            class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-100">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">
                        Confirm Rejection
                    </button>
                </div>
            </form>
        </div>
    </div>
</section>