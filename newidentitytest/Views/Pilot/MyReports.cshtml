@* 
    Piloter kan se og administrere sine egne rapporter her.
    Viser bare rapporter sendt inn av den nåværende pilotbrukeren med sortering og søkefunksjonalitet.
*@
@model IEnumerable<newidentitytest.Models.ReportListItem>
@{
    ViewData["Title"] = "My Reports";
    var sortBy = ViewBag.SortBy as string ?? "CreatedAt";
    var sortOrder = ViewBag.SortOrder as string ?? "desc";
    var search = ViewBag.Search as string ?? "";
}

<section class="container mx-auto">
    <header class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-semibold">My Reports (@Model.Count())</h1>
        <div class="flex items-center gap-2">
            @* Server-side search form with sort parameter preservation *@
            <form method="get" action="@Url.Action("MyReports")" class="flex items-center gap-2">
                <input type="text" name="search" value="@search" placeholder="Search..." 
                       class="rounded-lg ring-1 ring-gray-300 px-3 py-2" />
                <input type="hidden" name="sortBy" value="@sortBy" />
                <input type="hidden" name="sortOrder" value="@sortOrder" />
                <button type="submit" class="rounded-lg px-3 py-2 ring-1 ring-gray-300 hover:bg-gray-50">
                    Search
                </button>
                @if (!string.IsNullOrEmpty(search))
                {
                    <a href="@Url.Action("MyReports", new { sortBy = sortBy, sortOrder = sortOrder })" 
                       class="rounded-lg px-3 py-2 ring-1 ring-gray-300 hover:bg-gray-50">
                        Clear
                    </a>
                }
            </form>
            <a asp-controller="Obstacle" asp-action="DataForm"
               class="inline-flex items-center rounded-lg px-3 py-2 ring-1 ring-gray-300 hover:bg-gray-50">Create</a>
        </div>
    </header>

    @if (!Model.Any())
    {
        <div class="text-center py-12 bg-white rounded-lg shadow-sm ring-1 ring-gray-200">
            <p class="text-gray-600">No reports yet.</p>
        </div>
    }
    else
    {
        <div class="overflow-x-auto rounded-xl ring-1 ring-gray-200 bg-white">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                            <a href="@Url.Action("MyReports", new { sortBy = "id", sortOrder = sortBy == "id" && sortOrder == "asc" ? "desc" : "asc", search = search })" 
                               class="hover:text-gray-700">
                                ID
                                @if (sortBy == "id")
                                {
                                    <span>@(sortOrder == "asc" ? "^" : "v")</span>
                                }
                            </a>
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                            <a href="@Url.Action("MyReports", new { sortBy = "createdat", sortOrder = sortBy == "createdat" && sortOrder == "asc" ? "desc" : "asc", search = search })" 
                               class="hover:text-gray-700">
                                Created
                                @if (sortBy == "createdat")
                                {
                                    <span>@(sortOrder == "asc" ? "^" : "v")</span>
                                }
                            </a>
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                            <a href="@Url.Action("MyReports", new { sortBy = "obstacletype", sortOrder = sortBy == "obstacletype" && sortOrder == "asc" ? "desc" : "asc", search = search })" 
                               class="hover:text-gray-700">
                                Type
                                @if (sortBy == "obstacletype")
                                {
                                    <span>@(sortOrder == "asc" ? "^" : "v")</span>
                                }
                            </a>
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                            <a href="@Url.Action("MyReports", new { sortBy = "status", sortOrder = sortBy == "status" && sortOrder == "asc" ? "desc" : "asc", search = search })" 
                               class="hover:text-gray-700">
                                Status
                                @if (sortBy == "status")
                                {
                                    <span>@(sortOrder == "asc" ? "^" : "v")</span>
                                }
                            </a>
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">#@item.Id</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">@item.CreatedAt.ToString("MMM dd, yyyy HH:mm")</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">@(item.ObstacleType ?? "-")</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                @{
                                    var status = item.Status ?? "Pending";
                                    var statusClass = status.ToLowerInvariant() switch
                                    {
                                        "approved" => "bg-green-100 text-green-800",
                                        "rejected" => "bg-red-100 text-red-800",
                                        _ => "bg-yellow-100 text-yellow-800"
                                    };
                                }
                                <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium @statusClass">
                                    @status
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <a asp-controller="Reports" asp-action="Details" asp-route-id="@item.Id" 
                                   class="text-indigo-600 hover:text-indigo-900">View</a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</section>
